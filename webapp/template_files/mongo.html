{% extends "base.html" %}
{% block content %}
    <div class = "w-100">
        <div class = "d-flex justify-content-center mt-5">
            <div class = "d-grid gap-2 text-center" style = "width: 600px;">
                <h4 style="font-size: 46px; color: #333A41;">Crawling Results</h4>

                <div class = "d-flex justify-content-center">
                    <button id = "btn-marketplaces" class = "webapp-button btn m-1" type = "submit">Show Marketplaces</button>
                    <button id = "btn-crawl" class = "webapp-button btn m-1" type = "submit">Show Crawling Results</button>
                </div>
        </div>
    </div>

    <div class = "d-flex justify-content-center mt-3">
        <div id = "marketplaces-card" class = "mb-5" style = "display: none;">
            <div class="mb-4 border p-3 rounded" style = "width: 450px;">
                <h5 style="color: #333A41;">Add New Marketplace</h5>
                <form action = "/add-marketplace" method = "POST">
                    <div class="mb-2">
                        <input type="text" id="new-marketplace-name" name = "new-marketplace-name" class="form-control" placeholder="Marketplace name">
                    </div>
                    <div class="form-check form-switch mb-2">
                        <label class="form-check-label" for="switch-has-cookie">Has cookies</label>
                        <input class="form-check-input" type="checkbox" id = "switch-has-cookie">
                    </div>
                    <input type="hidden" id="has-cookie-value" name = "has-cookie-value" value="false">
                    <div class="mb-2">
                        <h6>Cookie</h6>
                        <div id="cookieInputs" class="mb-2"></div>
                        <div class="input-group">
                            <input type="text" id="new-cookies" name = "new-cookies" class="form-control" placeholder="Insert cookies using JSON format">
                            <button class="webapp-button btn" type="button" onclick="addCookieInput()">Add Cookie</button>
                        </div>
                    </div>
                    <div class = "text-center">
                        <button class="webapp-button btn mt-2">Add Marketplace</button>
                    </div>
                </form>
            </div>

            <!-- Accordion -->
            <div class="accordion" id="marketplaceAccordion">
                {% for marketplace in marketplaces %}
                <div class="accordion-item" data-id="{{ marketplace._id }}">
                    <h2 class="accordion-header" id="heading{{ loop.index }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
                            {{ marketplace.name }}
                        </button>
                    </h2>
                    <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#marketplaceAccordion">
                        <div class="accordion-body">
                            <p><strong>Has cookie:</strong> <span class="has-cookie">{{ marketplace.cookie }}</span></p>
                            {% if marketplace.cookie %}
                                <h5>Cookies List</h5>
                                <ul class="cookie-list list-group mb-2">
                                    {% for name, value in marketplace.cookies.items() %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ name }} => {{ value }}
                                        <form action="/remove-cookie" method="POST" style="margin:0">
                                            <input type="hidden" name="marketplace-name" value="{{ marketplace.name }}">
                                            <input type="hidden" name="cookie-name" value="{{ name }}">
                                            <button type="submit" class="webapp-button btn">Remove Cookie</button>
                                        </form>     
                                    </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p>No cookies available.</p>
                            {% endif %}
                            <div class="mb-3">
                                <form action = "/add-cookie" method = "POST"> 
                                    <input type="hidden" name="marketplace-name" value="{{ marketplace.name }}">
                                    <div class="d-flex gap-2 text-center mb-2">
                                        <input type="text" name="cookie-name" class="form-control" placeholder="Cookie name" required>
                                        <input type="text" name="cookie-value" class="form-control" placeholder="Cookie value" required> 
                                    </div>
                                    
                                    <div class = "text-center">
                                        <button class="webapp-button btn">Add Cookie</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div id = "crawl-card" class = "mb-5" style = "display: none;">
            <div class="d-flex gap-2 mb-3 justify-content-center">
                {% for mp in marketplaces %}
                    <form action = "/marketplace-results" method = "POST" style="margin:0">
                        <input type="hidden" name="marketplace-name" value="{{ mp.name }}">
                        <button class="webapp-button btn">{{ mp.name }}</button>
                    </form>
                {% endfor %}
            </div>

            <table id="crawlTable" class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Hash URL</th>
                        <th>Depth</th>
                        <th>Crawled</th>
                        <th>Inserted At</th>
                        <th>Downloaded At</th>
                        <th>Download Time</th>
                        <th>Retries</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in results %}
                    <tr>
                        <td>{{ item.hash_url }}</td>
                        <td>{{ item.depth }}</td>
                        <td>{{ item.crawled }}</td>
                        <td>{{ item.inserted_at }}</td>
                        <td>{{ item.downloaded_at }}</td>
                        <td>{{ item.download_time }}</td>
                        <td>{{ item.retries }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    
    
    <footer class = "d-flex fixed-bottom justify-content-between align-items-center">
        <div class = "d-flex">
            <a href = "{{ url_for('index') }}" class = "footer-item px-2">Home</a>
            <a href = "https://github.com/adriano22jr" class = "footer-item px-2">Github</a>
        </div>
        <a class = "footer-item px-2">Â© 2025 Crator-Web, adriano22_</a>
    </footer>
{% endblock %}